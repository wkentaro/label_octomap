<launch>

  <arg name="label_value" />
  <arg name="launch_main" default="true" />
  <arg name="rviz" default="true" />

  <!-- main -->

  <group if="$(arg launch_main)">
    <node name="look_around_bin_main"
          pkg="icra2017" type="look-around-bin.l"
          required="true">
    </node>
    <node name="rosbag_record"
          pkg="rosbag" type="record"
          args="/tf
                /robot/joint_states
                /look_around_bin_main/output/moved

                /label_image_decomposer/output/label_viz
                /right_hand_camera/rgb/camera_info /right_hand_camera/rgb/image_raw
                /right_hand_camera/depth_registered/camera_info /right_hand_camera/depth_registered/image_raw

                /label_octomap_server/output/marker_array/occupied_fg
                /label_octomap_server/output/marker_array/occupied_bg
                /label_octomap_server_target/output/marker_array/occupied_target
                /octomap_server_viewpoint_0/output/marker_array/occupied
                /octomap_server_viewpoint_1/output/marker_array/occupied
                /octomap_server_viewpoint_2/output/marker_array/occupied

                -O $(optenv HOME)/.ros/icra2017/$(arg label_value)_look_around_bin.bag
          ">
    </node>
  </group>

  <!-- common pipeline -->

  <arg name="MANAGER" value="look_around_bin_nodelet_manager" />
  <node name="$(arg MANAGER)"
        pkg="nodelet" type="nodelet" args="manager" />

  <arg name="INPUT_IMAGE" value="/right_hand_camera/rgb/image_rect_color" />
  <arg name="INPUT_CLOUD" value="/right_hand_camera/depth_registered/points" />

  <rosparam command="load" file="$(find hrp2_apc)/config/label_names.yaml" />

  <node name="fcn_object_segmentation"
        pkg="jsk_perception" type="fcn_object_segmentation.py">
    <remap from="~input" to="$(arg INPUT_IMAGE)" />
    <rosparam subst_value="true">
      gpu: 0
      model_name: fcn32s
      model_h5: $(find jsk_apc2016_common)/trained_data/fcn32s_6000.chainermodel
      proba_threshold: 0.5
    </rosparam>
    <remap from="~target_names" to="label_names" />
  </node>
  <node name="label_names_overlay"
        pkg="hrp2_apc" type="label_names_overlay.py">
    <remap from="~label_names" to="label_names" />
  </node>

  <!-- my method specific pipeline -->

  <node name="passthrough_cloud"
        pkg="nodelet" type="nodelet"
        args="load jsk_topic_tools/Passthrough $(arg MANAGER)">
    <remap from="~input" to="$(arg INPUT_CLOUD)" />
  </node>
  <node name="image_resizer"
        pkg="nodelet" type="nodelet"
        args="load resized_image_transport/ImageResizer $(arg MANAGER)">
        <remap from="~input/image" to="fcn_object_segmentation/output/proba_image" />
    <remap from="~output/image" to="fcn_object_segmentation/output/proba_image/quarter" />
    <rosparam>
      use_camera_info: false
      resize_scale_x: 0.25
      resize_scale_y: 0.25
      interpolation: NEAREST
    </rosparam>
  </node>
  <node name="resize_points_publisher"
        pkg="nodelet" type="nodelet"
        args="load jsk_pcl/ResizePointsPublisher $(arg MANAGER)">
    <remap from="~input" to="passthrough_cloud/output" />
    <remap from="~output" to="passthrough_cloud/output/quarter" />
    <rosparam>
      step_x: 4
      step_y: 4
    </rosparam>
  </node>
  <node name="label_octomap_server"
        pkg="octomap_server" type="label_octomap_server"
        output="screen">
    <remap from="cloud_in" to="passthrough_cloud/output/quarter" />
    <remap from="proba_image_in" to="fcn_object_segmentation/output/proba_image/quarter" />
    <remap from="octomap_point_cloud_centers" to="~output/points" />
    <remap from="cluster_indices" to="~output/cluster_indices" />
    <remap from="marker_array/occupied_fg" to="~output/marker_array/occupied_fg" />
    <remap from="marker_array/occupied_bg" to="~output/marker_array/occupied_bg" />
    <remap from="marker_array/free" to="~output/marker_array/free" />
    <rosparam>
      n_label: 40
      frame_id: base
      resolution: 0.01
      latch: false
      publish_periodically: true
      max_range: 1.0
    </rosparam>
  </node>
  <node name="label_octomap_server_target"
        pkg="octomap_server" type="label_octomap_server"
        output="screen">
    <remap from="cloud_in" to="passthrough_cloud/output/quarter" />
    <remap from="proba_image_in" to="fcn_object_segmentation/output/proba_image/quarter" />
    <remap from="octomap_point_cloud_centers" to="~output/points" />
    <remap from="cluster_indices" to="~output/cluster_indices" />
    <remap from="marker_array/occupied_fg" to="~output/marker_array/occupied_fg" />
    <remap from="marker_array/occupied_bg" to="~output/marker_array/occupied_target" />
    <remap from="marker_array/free" to="~output/marker_array/free" />
    <rosparam subst_value="true">
      bg_label: $(arg label_value)
      n_label: 40
      frame_id: base
      resolution: 0.01
      latch: false
      publish_periodically: true
      max_range: 1.0
    </rosparam>
  </node>

  <!-- pipeline for benchmark -->

  <node name="label_image_decomposer"
        pkg="jsk_perception" type="label_image_decomposer.py">
    <remap from="~input" to="$(arg INPUT_IMAGE)" />
    <remap from="~input/label" to="fcn_object_segmentation/output" />
    <remap from="~label_names" to="label_names" />
    <rosparam>
      approximate_sync: false
      queue_size: 100
    </rosparam>
  </node>
  <node name="label_to_mask_image"
        pkg="nodelet" type="nodelet"
        args="load jsk_perception/LabelToMaskImage $(arg MANAGER)">
    <remap from="~input" to="fcn_object_segmentation/output" />
    <rosparam subst_value="true">
      label_value: $(arg label_value)
    </rosparam>
  </node>
  <node name="mask_image_to_indices"
        pkg="nodelet" type="nodelet"
        args="load jsk_pcl_utils/MaskImageToPointIndices $(arg MANAGER)">
    <remap from="~input" to="label_to_mask_image/output" />
  </node>
  <node name="extract_indices"
        pkg="nodelet" type="nodelet"
        args="load jsk_pcl/ExtractIndices $(arg MANAGER)">
    <remap from="~input" to="$(arg INPUT_CLOUD)" />
    <remap from="~indices" to="mask_image_to_indices/output" />
    <rosparam>
      approximate_sync: true
      queue_size: 100
      keep_organized: true
    </rosparam>
  </node>
  <node name="resize_points_publisher_registration"
        pkg="nodelet" type="nodelet"
        args="load jsk_pcl/ResizePointsPublisher $(arg MANAGER)">
    <remap from="~input" to="extract_indices/output" />
    <remap from="~output" to="extract_indices/output/quarter" />
    <rosparam>
      step_x: 4
      step_y: 4
    </rosparam>
  </node>
  <node name="passthrough_viewpoint_0"
        pkg="nodelet" type="nodelet"
        args="load jsk_topic_tools/Passthrough $(arg MANAGER)">
    <remap from="~input" to="extract_indices/output/quarter" />
  </node>
  <node name="octomap_server_viewpoint_0"
        pkg="octomap_server" type="octomap_server_node">
    <remap from="cloud_in" to="passthrough_viewpoint_0/output" />
    <remap from="occupied_cells_vis_array" to="~output/marker_array/occupied" />
    <rosparam>
      frame_id: base
      resolution: 0.01
      latch: false
      max_range: 1.0
    </rosparam>
  </node>
  <node name="passthrough_viewpoint_1"
        pkg="nodelet" type="nodelet"
        args="load jsk_topic_tools/Passthrough $(arg MANAGER)">
    <remap from="~input" to="extract_indices/output/quarter" />
  </node>
  <node name="octomap_server_viewpoint_1"
        pkg="octomap_server" type="octomap_server_node">
    <remap from="cloud_in" to="passthrough_viewpoint_1/output" />
    <remap from="occupied_cells_vis_array" to="~output/marker_array/occupied" />
    <rosparam>
      frame_id: base
      resolution: 0.01
      latch: false
      max_range: 1.0
    </rosparam>
  </node>
  <node name="passthrough_viewpoint_2"
        pkg="nodelet" type="nodelet"
        args="load jsk_topic_tools/Passthrough $(arg MANAGER)">
    <remap from="~input" to="extract_indices/output/quarter" />
  </node>
  <node name="octomap_server_viewpoint_2"
        pkg="octomap_server" type="octomap_server_node">
    <remap from="cloud_in" to="passthrough_viewpoint_2/output" />
    <remap from="occupied_cells_vis_array" to="~output/marker_array/occupied" />
    <rosparam>
      frame_id: base
      resolution: 0.01
      latch: false
      max_range: 1.0
    </rosparam>
  </node>

  <!-- visualization -->

  <group if="$(arg rviz)">
    <node name="$(anon rviz)"
          pkg="rviz" type="rviz"
          args="-d $(find icra2017)/rvizconfig/look_around_bin.rviz">
    </node>
  </group>

</launch>
